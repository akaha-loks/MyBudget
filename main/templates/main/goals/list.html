{% extends 'main/base.html' %}
{% block title %}Цели{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="text-center mb-3">
        <h2>Мои цели</h2>
    </div>
    <hr  class="mb-4">
    <div class="row g-4">
        {% for goal in goals %}
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body d-flex flex-column">
                    <!-- Название и срок -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">{{ goal.name }}</h5>
                        <small class="text-muted">до {{ goal.deadline|date:"d.m.Y" }}</small>
                    </div>

                    <!-- Цифры -->
                    <p class="mb-1 text-muted small">Цель: <strong>{{ goal.target_amount }} сом</strong></p>
                    <p class="mb-2 text-muted small">Накоплено: <strong>{{ goal.current_amount }} сом</strong></p>

                    <!-- Прогресс -->
                    {% with pct=goal.progress_percent %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Прогресс</span>
                            <span>{{ pct }}%</span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: {{ pct }}%;"
                                 aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    {% endwith %}

                    <!-- Автоматический расчёт -->
                    {% with months_left=goal.months_left monthly_needed=goal.monthly_needed %}
                    {% if months_left > 0 %}
                        <p class="text-muted small mb-3">
                            Нужно откладывать: <strong>{{ monthly_needed|floatformat:0 }} сом/мес</strong>
                            (осталось {{ months_left }} мес)
                        </p>
                    {% else %}
                        <p class="text-muted small mb-3">Срок истёк</p>
                    {% endif %}
                    {% endwith %}

                    <!-- Кнопки -->
                    <div class="mt-auto">
                        <a href="{% url 'main:add_to_goal' goal.id %}" class="btn btn-sm btn-outline-primary w-100 mb-2">+ Добавить сумму</a>
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'main:goal_edit' goal.id %}" class="btn btn-sm btn-outline-secondary w-50 me-1">Изменить</a>
                            <form action="{% url 'main:goal_delete' goal.id %}" method="post" class="w-50 ms-1">
                                {% csrf_token %}
                                <button class="btn btn-sm btn-outline-danger w-100"
                                        onclick="return confirm('Удалить цель?')">Удалить</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-light shadow-sm text-center py-4">
                У вас ещё нет целей — добавьте первую.
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="d-flex justify-content-end mb-3">
        <a href="{% url 'main:goal_add' %}" class="btn btn-dark">+ Добавить цель</a>
    </div>
</div>
{% endblock %}
