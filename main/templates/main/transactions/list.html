{% extends 'main/base.html' %}

{% block title %}Транзакции{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Транзакции</h2>
    <hr class="mx-auto mb-4">

    <table class="table table-striped table-hover table-bordered">
        <thead class="table-dark">
            <tr>
                <th>
                    <a class="text-white fw-bold text-decoration-none" href="?sort={% if current_sort == 'date' %}-date{% else %}date{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                        Дата
                    </a>
                </th>
                <th>
                    <a class="text-white fw-bold text-decoration-none" href="?sort={% if current_sort == 'amount' %}-amount{% else %}amount{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                        Сумма
                    </a>
                </th>
                <th>
                    <a class="text-white fw-bold text-decoration-none" href="?sort={% if current_sort == 'type' %}-type{% else %}type{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                        Тип
                    </a>
                </th>
                <th>
                    <!-- Селект прямо в шапке -->
                    <form method="get" class="m-0 p-0 d-inline">
                        <select name="category" class="form-select form-select-sm"
                                onchange="this.form.submit()"
                                style="font-family: Arial, sans-serif;
                                       font-size: 0.9rem;
                                       color: #e4e4e4;
                                       background-color: #1e1f22;
                                       border-radius: 0.25rem;
                                       border-color: #1e1f22;
                                       padding: 0.25rem 0.5rem;">
                            <option value="">Все категории</option>
                            {% for c in categories %}
                                <option value="{{ c.id }}" {% if selected_category == c.id|stringformat:"s" %}selected{% endif %}>
                                    {{ c.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="sort" value="{{ current_sort }}">
                    </form>
                </th>
                <th>Комментарий</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for t in transactions %}
            <tr onclick="window.location='{% url 'main:transaction_edit' t.id %}'" style="cursor: pointer;">
                <td>{{ t.date|date:"d/m/Y H:i" }}</td>
                <td class="{% if t.type == 'income' %}text-success{% elif t.type == 'expense' %}text-danger{% endif %}">{{ t.amount }}с</td>
                <td class="{% if t.type == 'income' %}text-success{% elif t.type == 'expense' %}text-danger{% endif %}">{{ t.get_type_display }}</td>
                <td class="{% if t.type == 'income' %}text-success{% elif t.type == 'expense' %}text-danger{% endif %}">{% if t.category %}{{ t.category.name }}{% else %}Без категории{% endif %}</td>
                <td class="{% if t.type == 'income' %}text-success{% elif t.type == 'expense' %}text-danger{% endif %}">{{ t.description }}</td>
                <td>
                    <a href="{% url 'main:transaction_edit' t.id %}" class="{% if t.type == 'income' %}btn btn-sm btn-outline-success{% elif t.type == 'expense' %}btn btn-sm btn-outline-danger{% endif %}">Редактировать</a>
                    <a href="{% url 'main:transaction_delete' t.id %}" class="btn btn-sm btn-outline-dark">Удалить</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center">Транзакций нет</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Прогресс-бар доходы/расходы -->
    <div class="col-md-12 mt-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title text-center mb-3">
                    Соотношение доходов и расходов
                </h5>

                {% if income == 0 and expenses == 0 %}
                    <div class="text-center text-muted py-3">
                        Нет данных для отображения
                    </div>
                {% else %}
                    <div class="progress" style="height: 30px;">
                        <div
                                class="progress-bar bg-success"
                                role="progressbar"
                                style="width: {{ income_percent }}%;"
                                aria-valuenow="{{ income_percent }}"
                                aria-valuemin="0"
                                aria-valuemax="100">
                                Доходы {{ income_percent }}%
                        </div>
                        <div
                                class="progress-bar bg-danger"
                                role="progressbar"
                                style="width: {{ expense_percent }}%;"
                                aria-valuenow="{{ expense_percent }}"
                                aria-valuemin="0"
                                aria-valuemax="100">
                            Расходы {{ expense_percent }}%
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
